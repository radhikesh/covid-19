---
title: "Coronavirus"
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
---

``` {r setup, include=FALSE}
#--------------Packages-------------------------
library(devtools)
#devtools::install_github("RamiKrispin/coronavirus", force=T)
library(coronavirus)
library(flexdashboard)
library(tidyverse)
library(ggmap)
library(leaflet)
library(htmltools)
library(dplyr)
library(DT)
library(plotly)
library(data.table)

#-------------Data-------------------------------
data("coronavirus")
df <- coronavirus

df_us <- df %>% 
            dplyr::filter(Country.Region=="US" & type=="confirmed" & cases >=1) %>%
            dplyr::group_by(Country.Region, Province.State, Lat, Long) %>% summarise(total_cases=sum(cases))

df_us <- df_us %>% 
          dplyr::filter( !(Province.State %in% c('Guam','U.','Puerto Rico')))
#----------Mapping-------------------------------
m <- leaflet() %>%
  addTiles() %>% 
  addCircleMarkers(
  lng=df_us$Long, lat=df_us$Lat,
  radius = ifelse(df_us$total_cases < 5, 4,ifelse(df_us$total_cases >=5 &  df_us$total_cases < 25, 6,
                                                   ifelse(df_us$total_cases>=25 & df_us$total_cases <100,12,
                                                          ifelse(df_us$total_cases>=100 & df_us$total_cases <300,20,
                                                                 ifelse(df_us$total_cases>=300 & df_us$total_cases <600,30,
                                                                        ifelse(df_us$total_cases>=600 & df_us$total_cases <1000,40,50)))))),
  color = "red",
  stroke = FALSE, fillOpacity = 0.5,
  label = htmlEscape(paste0(df_us$Province.State,",",df_us$total_cases)))


#---------comparison--------------------------------
df_topten <- df %>% 
                filter(df$Country.Region %in% c("China","Italy","Iran","Spain","Korea, South",
                                                "Germany","France","US","Switzerland","United Kingdom") & cases >= 1 & type=="confirmed")

df_topten <- df %>% 
                filter(df$Country.Region %in% c("China","Italy","Iran","Spain","US") & cases >= 1 & type=="confirmed")

df_topten <- df_topten %>% 
                group_by(Country.Region, date) %>%
                arrange(Country.Region, date)

df_topten <- data.table(df_topten, key = c("Country.Region"))
df_topten[, csum := cumsum(cases), by = key(df_topten)]

# p <- df_topten %>% filter(Country.Region=="China") %>% 
#         ggplot(aes(x=date,y=csum)) + geom_line(color="#69b3a2")+ylab("Total Cumulative Cases") + theme_minimal()
# p <- ggplotly(p)
# p

p <- df_topten %>% 
        plot_ly(x=~date, y=~csum, group=~Country.Region,color=~Country.Region, mode="lines") %>% 
        layout(xaxis = list(range=as.POSIXct(c('2020-01-20', '2020-03-25')), title="Date", hovermode = "compare",
                 margin =  list(
                   # l = 60,
                   # r = 40,
                   b = 10,
                   t = 10,
                   pad = 2
                 )))
p
```


Map
=======================================================================
Row
-----------------------------------------------------------------------

### Covid-19 distribution across US
```{r}
m
```

Trend across countries.
=======================================================================
Row
-----------------------------------------------------------------------
```{r}
p
```




